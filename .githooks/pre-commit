#!/bin/bash
set -euo pipefail

echo "===================================="
echo "     Pre-Commit Quality Checks      "
echo "===================================="

# ------------------------------
# 1. Basic Secret Pattern Check
# ------------------------------
echo "[1/5] Checking for obvious hardcoded secrets..."
# Use regex trick to avoid self-matching
PATTERN="pass""word="

if grep -r -n "$PATTERN" . \
  --exclude-dir=.git \
  --exclude-dir=node_modules \
  --exclude-dir=.venv \
  --exclude-dir=.githooks \
  --exclude=*.md \
  --exclude=.gitignore \
  --color=never | grep -q .; then
  echo "ERROR: Potential secret detected (matched 'password='). Remove before committing."
  exit 1
fi
echo "Secrets pattern check passed."

# ------------------------------
# 2. Terraform Formatting
# ------------------------------
if [ -d "infra" ]; then
  echo "[2/5] Checking Terraform formatting..."
  if ! terraform fmt -check -recursive; then
    echo "ERROR: Terraform files are not properly formatted. Run: terraform fmt -recursive"
    exit 1
  fi
  echo "Terraform formatting check passed."
fi

# ------------------------------
# 3. Infrastructure Security (Checkov)
# ------------------------------
if command -v checkov >/dev/null 2>&1; then
  echo "[3/5] Running Checkov for IaC security scanning..."
  if ! checkov -d infra --quiet; then
    echo "ERROR: Checkov found IaC security/policy issues. Review before committing."
    exit 1
  fi
  echo "Checkov scan passed."
else
  echo "WARNING: Checkov not installed. Skipping IaC scan."
fi

# ------------------------------
# 4. Secret Scanning (Gitleaks)
# ------------------------------
if command -v gitleaks >/dev/null 2>&1; then
  echo "[4/5] Running Gitleaks for secret scanning..."
  if ! gitleaks detect --no-banner --redact; then
    echo "ERROR: Gitleaks found potential secrets. Clean them up before committing."
    exit 1
  fi
  echo "Gitleaks scan passed."
else
  echo "WARNING: Gitleaks not installed. Skipping advanced secret scan."
fi

# ------------------------------
# 5. Frontend Linting
# ------------------------------
if [ -f "app/web/package.json" ]; then
  echo "[5/5] Running frontend lint checks..."
  if ! (cd app/web && npm run lint); then
    echo "ERROR: Frontend linting failed. Fix issues before committing."
    exit 1
  fi
  echo "Frontend linting passed."
fi

echo "===================================="
echo " All pre-commit checks passed "
echo "===================================="
